# Opscode Omnibus #
Build instructions for (ruby) omnibus to build private chef within a VirtualBox
virtual machine.

# Prerequisites

## VirtualBox

Ensure you have downloaded and installed VirtualBox 4.1.6 from the [project website](https://www.virtualbox.org/wiki/Downloads).

# Initial Configuration

Ensure all required gems are installed and ready to use:

    bundle install

# omnibus-ruby

Clone the [omnibus-ruby][] repo as a sibling of this repo

[omnibus-ruby]: https://github.com/opscode/omnibus-ruby

# Create a config file

    cp omnibus.rb.example omnibus.rb

If you want to add S3 access, find the AWS credentials for the
"rs-preprod" account on the Corp Wiki.

# Build It!

To initiate an omnibus build on Ubuntu 10.04

```
bundle exec vagrant omnibus build ubuntu-10.04 private-chef
```

If you receive an error stating that no config file was found in /home/vagrant/opscode-omnibus/omnibus.rb, this means that a configuration file on the vagrant vm is missing.

SSH into the vagrant vm and copy over the sample configuration file found in the directory given by the error mesasge.

To SSH into the vm

```
vagrant ssh ubuntu-10.04
```

# Vagrant VM Management

The build environment utilizes the multi-vm functionality of Vagrant to execute builds across multiple platforms. For a quick primer on how to use Vagrant in a multi-vm setup see [the documentation](http://vagrantup.com/docs/multivm.html).

## Tips and Tricks

The following are some useful tips and tricks for using Vagrant in a multi-vm setup.

### Status

`vagrant status` will print the status of each VM in your environment:

```
> vagrant status
Current VM states:

ubuntu-10.04             not created
centos-6.0               running

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
```

### Up

`vagrant up` will create and provision all of the virtual build machines in your environment. In most cases, you will want to specify which type of VM you would like to build. To create an Ubuntu 10.04 VM, simply execute `vagrant up ubuntu-10.04`.

### SSH

`vagrant ssh` will log you in to the VM of your choice. To log in to your Ubuntu VM, execute `vagrant ssh ubuntu-10.04`.

### Rake

`rake projects:chef-full:deb` will build the chef-full project and produce a deb file.

`rake projects:chef-full:deb chef_git=master` will pull the master branch and build a deb instead
of building chef from gems.

## Put text here about the artifacts generated by the build process


# Upgrade upsteam software (populate S3 Cache)

Follow these steps to upgrade an upstream software package, for
example, the version of Erlang packaged with omnibus.

Update the config for the software package to include the new URL, md5
digest, and version. For Erlang, you need to edit
`config/software/erlang.rb`.

Next, you need to populate the S3 cache with the new file.

From inside the vm, run:

    bin/rake s3:populate

# Overrides

For testing and CI purposes, it is sometimes convenient to selectively
override the installed version of a particular software package
without having to commit changes to software descriptors (i.e.,
`config/software/$SOFTWARE.rb` files).  To do this, place a file named
`omnibus.overrides` in the root of this repository prior to a build.
The format is a simple, plain-text one; each line contains a software
name and version, separated by whitespace.  There are no comments, no
leading whitespace, and no blank lines.  For example:

```
oc-erchef my/branch
oc-chef-pedant deadbeef
```

The software name must match the name given in the corresponding
software descriptor file, and the version can be anything accepted by
Omnibus as a valid version (e.g., branch name, tag name, SHA1, etc.)

If present, the versions of the software packages in this file will
supercede versions in the corresponding software descriptor file.
Additionally, the information in the generated
`/opt/opscode/pc-versions.txt` file (installed by the generated
installer) will indicate which (if any) packages had their versions
overridden, and what the version would have been if it hadn't been
overridden.

