  server {
    listen <%= @helper.listen_port(@server_proto) %>;
    server_name <%= @server_name %>;

    access_log <%= @helper.access_log(@server_proto) %> opscode;
    <% if @server_proto == "https" %>
      ssl on;
      ssl_certificate <%= @ssl_certificate %>;
      ssl_certificate_key <%= @ssl_certificate_key %>;

      ssl_session_timeout 5m;

      ssl_protocols <%= @ssl_protocols %>;
      ssl_ciphers <%= @ssl_ciphers %>;
      ssl_prefer_server_ciphers on;
    <% end %>
    root <%= File.join(@dir, "html") %>;
    client_max_body_size <%= @client_max_body_size %>;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto <%= @x_forwarded_proto %>;
    proxy_pass_request_headers on;
    proxy_connect_timeout   1;
    proxy_send_timeout      300;
    proxy_read_timeout      300;

    error_page 404 =404 /404.html;
    error_page 503 =503 /503.json;

    location /version {
      types { }
      default_type text/plain;
      alias /opt/opscode/version-manifest.txt;
    }

    location /docs {
      index index.html ;
      alias /opt/opscode/docs;
    }

    # bookshelf
    location ~ "/<%= node['private_chef']['opscode-erchef']['s3_bucket'] %>/{0,1}.*$" {
      proxy_pass http://bookshelf;
    }

    # erchef status endpoint
    location ~ "^/_status/?$" {
      types { }
      default_type application/json;
      proxy_pass http://opscode_erchef;
    }

    # This internal location is used to serve checksum file content
    # via the X-Accel-Redirect header. See http://wiki.nginx.org/XSendfile
    location /checksum/ {
      internal;
      root <%= node['private_chef']['opscode-chef']['checksum_path'].gsub('checksum', '') %>;
    }

    # == darklaunch sub-request ==
    #
    # sets:
    # * dl_header: [nginx variable] string representation of darklaunch headers
    # # dl_config: [lua hash] hash representation of darklaunch features
    # * http header x-ops-darklaunch = dl_header
    #
    location ~ "/organizations/(?<org>[a-z0-9-_]+?)/darklaunch$" {
      internal;
      set $dl_header "";

      rewrite_by_lua '
        -- set ngx.var.dl_header
        ngx.var.dl_header = "<%= @helper.xdl_couchdb_headers %>"
        ngx.req.set_header("X-Ops-DarkLaunch", ngx.var.dl_header)

        -- set ngx.ctx.dl_config
        dl_config = {}
        dl_config["couchdb_checksums"]    = <%= @helper.not_xdl :sql_migration_phase_1 %>
        dl_config["couchdb_cookbooks"]    = <%= @helper.not_xdl :sql_migration_phase_1 %>
        dl_config["couchdb_environments"] = <%= @helper.not_xdl :sql_migration_phase_1 %>
        dl_config["couchdb_roles"]        = <%= @helper.not_xdl :sql_migration_phase_1 %>
        dl_config["couchdb_data"]         = <%= @helper.not_xdl :sql_migration_phase_1 %>
        dl_config["couchdb_clients"]      = <%= @helper.xdl :couchdb_clients %>
        ngx.ctx.dl_config = dl_config
      ';

      # We need to return a body. The caller of this sub-request will ignore the
      # body. Without it, Nginx will search the filesystem for the HTML file
      echo "";
    }

    # object ACL requests go to opscode-account service
    <%= @helper.account_api("^/organizations/[a-z0-9\-_]+?/.*?/_acl.*$", :account) %>

    # search requests
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/(?:search)/.+$") %>
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/(?:search)/?$") %>


    # backwards compatible for Chef 0.9.x and below clients
    # If we're using couchdb_cookbooks, then
    # the nodes/:node_name/cookbooks is still handled by Ruby-Chef
    <%= @helper.xdl_chef_api("^/organizations/[a-z0-9\-_]+?/nodes/[^/]+/cookbooks$", :xdl_couchdb_flag => 'cookbooks') %>

    # nodes and environments/*/nodes go to erchef
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/nodes/{0,1}.*$") %>
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/environments/[^/]+/nodes$") %>

    # data, roles, environments go to xdarklaunch
    <%= @helper.xdl_chef_api "^/organizations/(?<org>[a-z0-9\-_]+?)/(?<endpoint>data|roles|environments)/{0,1}.*$" %>

    # cookbooks, sandboxes go to xdarklaunch
    # Sandboxes always go where couchdb_cookbooks is set
    <%= @helper.xdl_chef_api "^/organizations/(?<org>[a-z0-9\-_]+?)/(?<endpoint>cookbooks|sandboxes)/{0,1}.*$",
                :xdl_couchdb_flag => 'cookbooks',
                :couchdb_upstream => @helper.upload_upstream %>

    # principals go to erchef
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/principals/{0,1}.*$") %>

    # We only let the Chef API handle clients if we're off CouchDB;
    # otherwise, it needs to be handled by opscode-account.
    <%- unless node['private_chef']['dark_launch']['couchdb_clients'] -%>
      <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/clients/{0,1}.*$", 'couchdb_clients') %>
    <%- end -%>

    <%- if node['private_chef']['lb']['cache_cookbook_files'] && !node['private_chef']['dark_launch']['sql_migration_phase_1'] -%>
    # optional caching of cookbook files by nginx
    # Available only with couchdb_cookbooks (sql_migration_phase_1 off)
    location ~ "^/organizations/[a-z0-9\-_]+?/cookbooks/[\w\.]+/(\d+\.\d+\.\d+|_latest)/files/.+$" {
    <%= @helper.select_upstream("#{node['private_chef']['opscode-chef']['upload_vip']}:#{node['private_chef']['opscode-chef']['upload_port']}",
                                "opscode_webui",
                                node['private_chef']['opscode-chef']['upload_proto']) %>
      proxy_cache webui-cache;
      proxy_cache_valid 200 300m;
    }
    <%- end -%>

    # Status endpoint
    <%= @helper.chef_api("^/organizations/[a-z0-9\-_]+?/status/{0,1}.*$", :ruby) %>

    # Include external routes for addons
    include <%= node['private_chef']['nginx']['dir'] %>/etc/addon.d/*_external.conf;

    # opscode-account service endpoints

    # We only let the Chef API handle clients if we're off CouchDB;
    # otherwise, it needs to be handled by opscode-account.
    <%- if node['private_chef']['dark_launch']['couchdb_clients'] -%>
      <%= @helper.account_api("^/organizations/[a-z0-9\-_]+?/clients/{0,1}.*$", 'couchdb_clients') %>
    <%- end -%>

    <%= @helper.account_api("^/organizations/[a-z0-9\-_]+?/(?:groups|users|containers|association_requests)/{0,1}.*$", :account) %>
    <%= @helper.account_api("^/(?:organizations|users)/{0,1}$", :account) %>
    <%= @helper.account_api("^/organizations/[a-z0-9\-_]+/{0,1}$", :account) %>
    <%= @helper.account_api("^/users/[a-z0-9\-_]+/{0,1}$", :account) %>
    <%= @helper.account_api("^/users/[a-z0-9\-_]+/{0,1}/association_requests/{0,1}.*$", :account) %>
    <%= @helper.account_api("^/users/[a-z0-9\-_]+/organizations/{0,1}$", :account) %>
    <%= @helper.account_api("^/verify_password$", :account) %>
    <%= @helper.account_api("^/authenticate_user$", :account) %>

    location ~ "^/(?:stylesheets|javascripts|images|facebox|css|favicon|robots|humans)/{0,1}.*$" {
      if ($http_x_chef_version ~* "^(\d+\.\d+?)\..+$") {
        error_page 400 =400 /400-chef_client_manage.json;
        return 400;
      }

      # When configured to allow webui access to only certain subnets,
      # create "allow" rules for them, followed by deny all.
      # NOTE: This snippet is duplicated for the "/" location below.
      # Copy changes you make here down there as well.
      <% if @allowed_webui_subnets && !@allowed_webui_subnets.empty? %>
        <% @allowed_webui_subnets.each do |subnet| %>
      allow <%= subnet %>;
        <% end %>
      deny all;
      <% end %>

      proxy_pass http://opscode_webui;
      proxy_pass_request_headers off;
      proxy_cache webui-cache;
      proxy_cache_valid 200 302 300m;
      proxy_cache_valid 404 1m;
    }

    location / {
      # any request from a chef client that reaches this point
      # is for a resource/route that doesn't exist.
      if ($http_x_chef_version ~* "^(\d+\.\d+?)\..+$") {
         error_page 404 =404 /404.json;
         return 404;
      }

      # When configured to allow webui access to only certain subnets,
      # create "allow" rules for them, followed by deny all.
      # NOTE: This snippet is duplicated for the static assets locations above.
      # Copy changes you make here up there as well.
      <% if @allowed_webui_subnets && !@allowed_webui_subnets.empty? %>
        <% @allowed_webui_subnets.each do |subnet| %>
      allow <%= subnet %>;
        <% end %>
      deny all;
      <% end %>


      proxy_pass http://opscode_webui;
    }
  }
