%% -*- mode: erlang -*-
%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ts=4 sw=4 ft=erlang et

[
  {kernel, [{start_pg2, true}]},
  %% SASL config
  {sasl, [
         {sasl_error_logger, {file, "<%= File.join(@log_directory, 'sasl-error.log') %>"}},
         {errlog_type, error},
         {error_logger_mf_dir, "<%= File.join(@log_directory, 'sasl') %>"},      % Log directory
         {error_logger_mf_maxbytes, 104857600},   % 10 MB max file size
         {error_logger_mf_maxfiles, 5}           % 5 files max
        ]},
  {fast_log, [
               {loggers, [[{name, reporting},
                           {file, "<%= File.join(@log_directory, 'reporting.log') %>"},
                           {files, 5},
                           {file_size, 50}]]}
              ]},
  {chef_db, [
             %% TODO: cache_defaults here are unused past oc_reporting/master on 1/31/13.
             %% Remove when no longer needed.
             {cache_defaults, [{max_size, <%= @max_cache_size %> },
                                 {ttl, <%= @cache_ttl %> }]},
             {couchdb_host, "<%= node['private_chef']['couchdb']['vip'] %>"},
             {couchdb_port, <%= node['private_chef']['couchdb']['port'] %> }
            ]},
  {chef_authn, [
                  {keyring, [{default, "/etc/opscode/webui_pub.pem"},
                             {pivotal, "/etc/opscode/pivotal.pem"}]}
                 ]},
  {oc_chef_authz, [
                  {authz_root_url, "http://<%= node['private_chef']['opscode-authz']['vip'] %>:<%= node['private_chef']['opscode-authz']['port'] %>" },
                  {couchdb_host, "<%= node['private_chef']['couchdb']['vip'] %>"},
                  {couchdb_port, <%= node['private_chef']['couchdb']['port'] %> }
                 ]},
  {chef_index, [
                  {solr_url, "http://<%= node['private_chef']['opscode-solr']['vip'] %>:<%= node['private_chef']['opscode-solr']['port'] %>/solr"}
                 ]},
  {reporting, [{server_name, "<%= @server_name %>" },
            {ip, "<%= @listen %>" },
            {port, <%= @port %> },
            {log_dir, "<%= @log_directory %>"},
            {node_search_limit, "<%= @node_search_limit %>" },
            {metrics_module, folsom_metrics},
            {summary_only_percentage, <%= @summary_only_percentage %>},
            {summary_client_min_version, "<%= @summary_client_min_version %>" },
            {worker_count, <%= node['private_chef']['opscode-reporting']['node_run_worker_count'] %> },
            {rabbitmq_host, "<%= node['private_chef']['rabbitmq']['vip'] %>"},
            {rabbitmq_port, <%= node['private_chef']['rabbitmq']['node_port'] %> },
            {rabbitmq_user, <<"<%= node['private_chef']['rabbitmq']['reports_user'] %>">>},
            {rabbitmq_password, <<"<%= node['private_chef']['rabbitmq']['reports_password'] %>">>},
            {rabbitmq_vhost, <<"<%= node['private_chef']['rabbitmq']['reports_vhost'] %>">>},
            {stats_hero_app_name, <<"reportingAPI">>},
            {chef_base_url, "https://<%= node['private_chef']['lb']['vip'] %>"},
            {erchef_base_url, "http://<%= node['private_chef']['opscode-erchef']['listen'] %>:<%= node['private_chef']['opscode-erchef']['port'] %>"},
            {org_guid_cache, [{max_size, <%= @org_cache_size %>}, {ttl, <%= @org_cache_ttl %>}]},
            {principals_cache, [{max_size, <%= @principals_cache_size %>}, {ttl, <%= @principals_cache_ttl %>}]}
            ]},
  {stats_hero, [
               {udp_socket_pool_size, <%= node['private_chef']['postgresql']['max_connections'] %> },
               {estatsd_host, "<%= node['private_chef']['estatsd']['vip'] %>"},
               {estatsd_port, <%= node['private_chef']['estatsd']['port'] %>}
               ]},
  {sqerl, [
             %% The database system you are using (e.g., mysql, pgsql)
             {db_type, <%= node['private_chef']['database_type'] == "postgresql" ? "pgsql" : "mysql" %> },

             %% Database connection parameters
             {db_host, "<%= node['private_chef'][node['private_chef']['database_type']]['vip'] %>"},
             {db_port, <%= node['private_chef']['database_type'] == "postgresql" ? 5432 : 3306 %>},
             {db_user, "<%= node['private_chef'][node['private_chef']['database_type']]['sql_user'] %>"},
             {db_pass, "<%= node['private_chef'][node['private_chef']['database_type']]['sql_password'] %>"},
             {db_name, "opscode_reporting" },

             {prepared_statements, {reporting_sql, statements, [<%= node['private_chef']['database_type'] == "postgresql" ? "pgsql" : "mysql" %>]}},
             {column_transforms, undefined}
             ]},
  {pooler, [
            {pools, [
                     [{name, "sqerl"},
                       {max_count, <%= node['private_chef']['opscode-reporting']['db_pool_max_count'] %> },
                       {init_count, <%= node['private_chef']['opscode-reporting']['db_pool_init_count'] %> },
                       {start_mfa, {sqerl_client, start_link, []}}],
                     [{name, "node_run_sender"},
                       {max_count, <%= node['private_chef']['opscode-reporting']['node_run_max_sender_count'] %> },
                       {init_count, <%= node['private_chef']['opscode-reporting']['node_run_init_sender_count'] %> },
                       {start_mfa, {node_run_sender, start_link, []}}]
                    ]}
            ]}
].



